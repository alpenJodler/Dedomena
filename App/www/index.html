<!DOCTYPE html>
<html>
<head>
    <!--
        Customize the content security policy in the meta tag below as needed. Add 'unsafe-inline' to default-src to enable inline JavaScript.
        For details, see http://go.microsoft.com/fwlink/?LinkID=617521
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap://ready file://* *; style-src 'self' http://* https://* 'unsafe-inline'; script-src 'self' http://* https://* 'unsafe-inline' 'unsafe-eval'; media-src *">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">

    <title>App</title>

    <!--Additional packages for Here Map framework-->
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css?dp-version=1542186754" />
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>

    <!--Bootstrap Link-->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <!--Stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/index.css">
</head>

<body>
    <div class="container-fluid main-wrapper" id="mapContainer">
        <button onclick="startTracking()">Start Tracking</button>
        <button onclick="stopTracking()">Stop Tracking</button>
        <p id="geolocation">Finding geolocation...</p>
    </div>
    <script type="text/javascript">
        // Initialize the platform object:
        var platform = new H.service.Platform({
            'app_id': 'YVx7VH25wvkdlUFvGjC8',
            'app_code': '_DmLSgB2oR1uQ1LrG0GbVQ'
        });
        var pixelRatio = window.devicePixelRatio || 1;
        var defaultLayers = platform.createDefaultLayers({
            tileSize: pixelRatio === 1 ? 256 : 512,
            ppi: pixelRatio === 1 ? undefined : 320
        });

        // Obtain the default map types from the platform object
        var maptypes = platform.createDefaultLayers();
        // Instantiate (and display) a map object:
        var map = new H.Map(document.getElementById('mapContainer'),
            defaultLayers.normal.map, defaultLayers.normal.map, { pixelRatio: pixelRatio });

        //Step 3: make the map interactive
        // MapEvents enables the event system
        // Behavior implements default interactions for pan/zoom (also on mobile touch environments)
        var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

        // Create the default UI components
        var ui = H.ui.UI.createDefault(map, defaultLayers);

        function enableTrafficInfo(map) {
            // Show traffic tiles
            map.setBaseLayer(defaultLayers.normal.traffic);

            // Enable traffic incidents layer
            map.addLayer(defaultLayers.incidents);
        }

        // Wait for PhoneGap to load
        document.addEventListener("deviceready", onDeviceReady, false);

        // PhoneGap is ready
        function onDeviceReady() {
            navigator.geolocation.getCurrentPosition(onSuccess, onError);
        }

        // onSuccess Geolocation
        //
        function onSuccess(position) {
            var element = document.getElementById('geolocation');
            element.innerHTML = 'Latitude: ' + position.coords.latitude + '<br />' +
                'Longitude: ' + position.coords.longitude + '<br />' +
                'Altitude: ' + position.coords.altitude + '<br />' +
                'Accuracy: ' + position.coords.accuracy + '<br />' +
                'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '<br />' +
                'Heading: ' + position.coords.heading + '<br />' +
                'Speed: ' + position.coords.speed + '<br />' +
                'Timestamp: ' + new Date(position.timestamp) + '<br />';

            map.addObject(new H.map.Marker({
                lat: position.coords.latitude,
                lng: position.coords.longitude
            }));
            map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
            map.setZoom(14);
        }

        // onError Callback receives a [PositionError](PositionError/positionError.html) object
        function onError(error) {
            alert('code: ' + error.code + '\n' +
                'message: ' + error.message + '\n');
        }

        // onTracking update the device's current position when a change in position is detected
        function onTracking(position) {
            map.addObject(new H.map.Marker({
                lat: position.coords.latitude,
                lng: position.coords.longitude
            }));
            map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
            map.setZoom(14);

            // Connecting to the database and uploading un/structured data
            var mysql = require('mysql');

            var con = mysql.createConnection({
                host: "localhost",
                user: "root",
                password: "passwd",
                database: "dedomena"
            });

            con.connect(function (err) {
                if (err) throw err;
                console.log("Connected!");
                var sql = "INSERT INTO customers (name, address) VALUES ('Company Inc', 'Highway 37')";
                con.query(sql, function (err, result) {
                    if (err) throw err;
                    console.log("record inserted");
                });
            });
        }

        // Starting a thread to push the device informartion
        var watchID;
        function startTracking() {            
            enableTrafficInfo(map); // Now enable traffic tiles and traffic incidents
            watchID = navigator.geolocation.watchPosition(onTracking, onError, { enableHighAccuracy: true });
        }

        function stopTracking() {
            navigator.geolocation.clearWatch(watchID);
        }

    </script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>

    <!--Responsive scripts: JQuery, Popper, Bootstrap-->
    <script type="text/javascript" src="../bower_components/jQuery/dist/jquery.slim.js"></script>
    <script type="text/javascript" src="../bower_components/popper.js/dist/popper.min.js"></script>
    <script type="text/javascript" src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
</body>
</html>
